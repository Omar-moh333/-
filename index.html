<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ§Ù‚Ù Ø§Ù„Ø°ÙƒÙŠ â€” Smart Parking (EGP)</title>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root{
            --bg: #f6f8fb;
            --card: #ffffff;
            --muted: #7b8aa3;
            --accent: #1652f0; /* primary */
            --accent-2: #06b39a; /* success/green */
            --danger: #ff4d6d;
            --warning: #f39c12;
            --glass: rgba(255,255,255,0.6);
            --shadow: 0 8px 28px rgba(14,30,37,0.06);
            --radius: 12px;
            --text: #0f1724;
            --egp: "Ø¬Ù†ÙŠÙ‡";
        }

        *{box-sizing:border-box}
        html,body{height:100%}
        body{
            margin:0;
            font-family: 'Inter', Arial, sans-serif;
            background: linear-gradient(180deg,#f6f8fb 0%, #eef3fb 100%);
            color:var(--text);
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            direction: rtl;
        }

        /* App container */
        .app {
            min-height:100vh;
            display:flex;
            flex-direction:column;
        }

        /* Top header */
        .header {
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:18px 28px;
            gap:16px;
            background:linear-gradient(90deg, rgba(22,82,240,1) 0%, rgba(6,179,154,1) 100%);
            color:white;
            box-shadow: 0 6px 22px rgba(13,37,71,0.12);
        }

        .brand {
            display:flex;
            gap:12px;
            align-items:center;
        }

        .brand .logo {
            width:46px;
            height:46px;
            border-radius:10px;
            background:rgba(255,255,255,0.12);
            display:flex;
            align-items:center;
            justify-content:center;
            font-weight:800;
            font-size:20px;
            box-shadow: inset 0 -4px 12px rgba(0,0,0,0.06);
        }

        .brand h1{
            font-size:18px;
            margin:0;
            line-height:1;
        }

        .brand p{
            margin:0;
            font-size:12px;
            opacity:0.95;
        }

        .header-actions {
            display:flex;
            align-items:center;
            gap:14px;
        }

        .search {
            background: rgba(255,255,255,0.12);
            border-radius:10px;
            padding:8px;
            display:flex;
            gap:8px;
            align-items:center;
            min-width:280px;
            color:white;
        }

        .search input{
            background:transparent;
            border:0;
            outline:0;
            color:white;
            width:100%;
            font-size:14px;
        }

        .btn {
            border:0;
            padding:10px 14px;
            border-radius:10px;
            cursor:pointer;
            font-weight:600;
            display:inline-flex;
            align-items:center;
            gap:8px;
            transition:all .18s ease;
            box-shadow:none;
        }

        .btn.ghost {
            background: rgba(255,255,255,0.12);
            color: white;
        }

        .btn.primary {
            background: white;
            color: var(--accent);
        }

        .btn.success {
            background: var(--accent-2);
            color: white;
        }

        .user-card {
            background: rgba(255,255,255,0.08);
            padding:8px 10px;
            border-radius:10px;
            display:flex;
            gap:8px;
            align-items:center;
            color:white;
        }

        .user-card img{
            width:36px;
            height:36px;
            border-radius:10px;
            object-fit:cover;
            border:2px solid rgba(255,255,255,0.12);
        }

        /* Main content area */
        .container {
            max-width:1200px;
            margin:22px auto;
            width:calc(100% - 40px);
            display:grid;
            grid-template-columns: 360px 1fr;
            gap:20px;
            align-items:start;
        }

        /* Left panel */
        .panel {
            background:var(--card);
            border-radius:var(--radius);
            padding:18px;
            box-shadow:var(--shadow);
        }

        .panel h3 { margin:0 0 12px 0; font-size:16px; }
        .balance {
            display:flex;
            flex-direction:column;
            gap:6px;
            padding:12px;
            border-radius:10px;
            background: linear-gradient(90deg, rgba(6,179,154,0.06), rgba(22,82,240,0.04));
            border:1px solid rgba(15,23,36,0.03);
        }
        .balance .amount {
            font-weight:800;
            font-size:20px;
            color:var(--accent);
        }
        .balance small{ color:var(--muted) }

        .filter-group { margin-top:14px; display:flex; flex-direction:column; gap:10px; }
        select.form-control, input.form-control {
            padding:10px 12px;
            border-radius:8px;
            border:1px solid #e7eef8;
            font-size:14px;
        }

        .locations-list { margin-top:14px; display:flex; flex-direction:column; gap:10px; }
        .loc-item {
            display:flex;
            justify-content:space-between;
            gap:10px;
            padding:10px;
            border-radius:8px;
            align-items:center;
            background: linear-gradient(180deg,#fff,#fbfdff);
            border:1px solid #f0f5fb;
        }
        .loc-item small { color:var(--muted); font-size:13px }

        .actions-row { margin-top:12px; display:flex; gap:8px; }

        /* Right panel (grid) */
        .grid-area {
            display:flex;
            flex-direction:column;
            gap:14px;
        }

        .topbar {
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:12px;
        }

        .stats {
            display:flex;
            gap:12px;
            align-items:center;
        }

        .stat {
            background: linear-gradient(180deg,#fff,#fbfdff);
            border-radius:10px;
            padding:10px 12px;
            box-shadow: var(--shadow);
            border:1px solid #f0f5fb;
            display:flex;
            align-items:center;
            gap:10px;
            font-weight:700;
            min-width:110px;
        }

        .parking-grid {
            display:grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap:16px;
        }

        .slot {
            background: linear-gradient(180deg,#fff,#fcfeff);
            border-radius:12px;
            padding:12px;
            box-shadow:var(--shadow);
            border:1px solid #eef6ff;
            display:flex;
            flex-direction:column;
            gap:10px;
            transition:transform .18s ease, box-shadow .18s ease;
        }

        .slot:hover { transform:translateY(-6px); box-shadow: 0 18px 40px rgba(14,30,37,0.08) }

        .slot-head {
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:10px;
        }

        .slot-number {
            font-weight:800;
            font-size:15px;
        }

        .badge {
            padding:6px 8px;
            border-radius:999px;
            font-weight:700;
            font-size:12px;
            color:white;
        }

        .badge.available { background: var(--accent-2) }
        .badge.occupied { background: var(--danger) }
        .badge.maintenance { background: #6b6f76 }
        .badge.vip { background: linear-gradient(90deg,#d97706,#f59e0b) }

        .slot-body small { color:var(--muted) }

        .price {
            font-weight:800;
            font-size:16px;
            color:var(--accent);
        }

        .slot-actions {
            display:flex;
            gap:8px;
            margin-top:8px;
        }

        .btn-block {
            flex:1;
            padding:10px;
            border-radius:10px;
            border:0;
            font-weight:700;
            cursor:pointer;
        }

        .btn-book { background:linear-gradient(90deg,var(--accent-2),#08a07f); color:white }
        .btn-disabled { background:#eef2f6; color:var(--muted); cursor:not-allowed }

        /* Booking modal */
        .modal-backdrop {
            display:none;
            position:fixed;
            inset:0;
            background: rgba(6,13,31,0.45);
            z-index:1200;
            align-items:center;
            justify-content:center;
            padding:20px;
        }

        .modal {
            width:100%;
            max-width:560px;
            background:white;
            border-radius:12px;
            padding:18px;
            box-shadow: 0 20px 60px rgba(7,19,41,0.35);
        }

        .modal h3{ margin:0 0 12px 0 }
        .form-row { display:flex; gap:8px; align-items:center }
        .form-row > * { flex:1 }

        .qr-box {
            border-radius:10px;
            padding:12px;
            border:1px dashed #e6eefb;
            text-align:center;
        }

        /* bookings list */
        .bookings-list { margin-top:12px; display:flex; flex-direction:column; gap:10px }
        .booking-item {
            display:flex;
            justify-content:space-between;
            gap:8px;
            padding:10px;
            border-radius:8px;
            background:#fff;
            border:1px solid #f0f5fb;
            align-items:center;
        }

        /* responsive */
        @media (max-width: 980px){
            .container { grid-template-columns: 1fr; width:calc(100% - 32px) }
            .search { min-width:unset }
            .header { padding:14px }
        }

        /* small helper */
        .muted { color:var(--muted); font-size:13px }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="brand">
                <div class="logo">ğŸ…¿ï¸</div>
                <div>
                    <h1>Smart Parking â€” Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ§Ù‚Ù Ø§Ù„Ø°ÙƒÙŠ</h1>
                    <p>ÙƒÙ‡Ø±Ø¨Ø© Ø§Ù„Ø­Ø¬Ø² Ùˆ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ù â€” Ø§Ù„Ø¹Ù…Ù„Ø©: Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ (EGP)</p>
                </div>
            </div>

            <div class="header-actions">
                <div class="search" title="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆÙ‚Ù Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="opacity:.9">
                        <path d="M21 21l-4.35-4.35" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="11" cy="11" r="6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <input id="globalSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆÙ‚ÙØŒ Ù…ÙˆÙ‚Ø¹ØŒ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©..." />
                </div>

                <button class="btn ghost" onclick="toggleFilterPanel()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="opacity:.95">
                        <path d="M22 7H2" stroke="white" stroke-width="2" stroke-linecap="round"/><path d="M6 12h12" stroke="white" stroke-width="2" stroke-linecap="round"/><path d="M10 17h4" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    ÙØ±Ø²/ØªØµÙÙŠØ©
                </button>

                <div class="user-card" id="authArea">
                    <img src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=400&auto=format&fit=crop&ixlib=rb-4.0.3&s=1e5a3d737c5f1b3f9e3d4b0c0c8b6f14" alt="avatar" />
                    <div>
                        <div style="font-weight:800" id="userNameHeader">Ø²Ø§Ø¦Ø±</div>
                        <small class="muted" id="userPlateHeader">Ù„Ù… ØªÙØ³Ø¬Ù„ Ø¨Ø¹Ø¯</small>
                    </div>
                </div>

                <button class="btn primary" id="loginBtn" onclick="showRegister()">Ø§Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ / ØªØ³Ø¬ÙŠÙ„</button>
            </div>
        </header>

        <!-- Main layout -->
        <main class="container">
            <!-- left panel -->
            <aside class="panel" id="leftPanel">
                <h3>Ø­Ø³Ø§Ø¨Ùƒ & ØªØµÙÙŠØ© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</h3>

                <div class="balance" style="margin-top:8px">
                    <div class="muted">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
                    <div class="amount" id="userBalance">-- Ø¬.Ù…</div>
                    <small class="muted">ÙŠÙ…ÙƒÙ†Ùƒ Ø´Ø­Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø£Ùˆ Ø§Ù„Ø¯ÙØ¹ Ù†Ù‚Ø¯Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</small>
                </div>

                <div class="filter-group">
                    <label class="muted">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù‚Ø±ÙŠØ¨</label>
                    <select id="areaFilter" class="form-control" onchange="applyFilters()">
                        <option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</option>
                        <option value="college">ÙƒÙ„ÙŠØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ</option>
                        <option value="uni">Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</option>
                        <option value="dispacito">ÙƒØ§ÙÙŠÙ‡ Ø¯ÙŠØ³Ø¨Ø§Ø³ÙŠØªÙˆ</option>
                        <option value="oasis">ÙƒØ§ÙÙŠÙ‡ ÙˆØ§Ø­Ø© Ø§Ù„Ø¨ÙƒØ±ÙŠ</option>
                        <option value="central">Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</option>
                    </select>

                    <label class="muted">Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆÙ‚Ù</label>
                    <select id="typeFilter" class="form-control" onchange="applyFilters()">
                        <option value="all">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                        <option value="regular">Ø¹Ø§Ø¯ÙŠ</option>
                        <option value="vip">Ù…Ù…ÙŠØ²</option>
                        <option value="disabled">Ø°ÙˆÙŠ Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª</option>
                    </select>

                    <div class="actions-row">
                        <button class="btn success" onclick="showTopUp()" style="width:100%">Ø´Ø­Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©</button>
                        <button class="btn ghost" onclick="viewMyBookings()" style="width:100%">Ø­Ø¬ÙˆØ²Ø§ØªÙŠ</button>
                    </div>
                </div>

                <div style="margin-top:14px">
                    <h3 style="font-size:14px; margin-bottom:8px">Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù‚Ø±ÙŠØ¨Ø©</h3>
                    <div class="locations-list" id="locationsList">
                        <!-- populated by JS -->
                    </div>
                </div>
            </aside>

            <!-- right panel -->
            <section class="grid-area">
                <div class="topbar">
                    <div>
                        <h2 style="margin:0">Ø§Ù„Ù…ÙˆØ§Ù‚Ù Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>
                        <small class="muted">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ù Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø£Ùˆ Ø§Ù„Ø£Ù†Ø³Ø¨ Ù„Ùƒ â€” Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡ Ø§Ù„Ù…ØµØ±ÙŠ (EGP/Ø³Ø§Ø¹Ø©)</small>
                    </div>

                    <div class="stats">
                        <div class="stat" id="statTotal">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: 0</div>
                        <div class="stat" id="statAvailable">Ù…ØªØ§Ø­: 0</div>
                        <div class="stat" id="statOccupied">Ù…Ø­Ø¬ÙˆØ²: 0</div>
                    </div>
                </div>

                <div class="parking-grid" id="parkingGrid">
                    <!-- slot cards injected by JS -->
                </div>

                <!-- my bookings list (for mobile/quick view) -->
                <div class="panel" id="recentBookingsPanel" style="margin-top:14px">
                    <h3>Ø¢Ø®Ø± Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h3>
                    <div class="bookings-list" id="bookingsList">
                        <!-- injected -->
                    </div>
                </div>
            </section>
        </main>

        <!-- Booking Modal -->
        <div class="modal-backdrop" id="modalBackdrop">
            <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
                <h3 id="modalTitle">Ø­Ø¬Ø² Ù…ÙˆÙ‚Ù</h3>
                <div id="modalContent">
                    <!-- injected -->
                </div>

                <div style="display:flex; gap:8px; margin-top:12px">
                    <button class="btn btn-block btn-book" id="confirmBookingBtn" onclick="confirmBooking()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²</button>
                    <button class="btn btn-block" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>

        <!-- Simple top-up / register modal (re-uses backdrop) -->
        <div class="modal-backdrop" id="registerBackdrop" style="display:none">
            <div class="modal">
                <h3 id="registerTitle">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ / Ø´Ø­Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©</h3>
                <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px">
                    <input id="regName" class="form-control" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ (Ù…Ø·Ù„Ùˆ Ø¨)"/>
                    <input id="regEmail" class="form-control" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"/>
                    <input id="regPlate" class="form-control" placeholder="Ø±Ù‚Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©"/>
                    <input id="regPassword" type="password" class="form-control" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"/>
                    <div style="display:flex; gap:8px">
                        <button class="btn primary" onclick="submitRegister()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
                        <button class="btn ghost" onclick="closeRegister()">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top-up modal -->
        <div class="modal-backdrop" id="topupBackdrop" style="display:none">
            <div class="modal">
                <h3>Ø´Ø­Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©</h3>
                <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px">
                    <input id="topupAmount" class="form-control" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡ (Ù…Ø«Ø§Ù„: 100)"/>
                    <div style="display:flex; gap:8px">
                        <button class="btn success" onclick="submitTopUp()">Ø´Ø­Ù† Ø§Ù„Ø¢Ù†</button>
                        <button class="btn ghost" onclick="closeTopUp()">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        /***************
         * Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
         ***************/
        let currentUser = JSON.parse(localStorage.getItem('current_user')) || null;
        let users = JSON.parse(localStorage.getItem('parking_users')) || [];
        let bookings = JSON.parse(localStorage.getItem('parking_bookings')) || [];

        // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ù â€” Ø£Ø¶ÙØª 12 Ù…ÙˆÙ‚ÙÙ‹Ø§ Ø¨Ù…ÙˆØ§Ù‚Ø¹ Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        const sampleSlots = [
            { id: 1, number: "C-01", location: "Ù…Ø¬Ø§ÙˆØ± ÙƒÙ„ÙŠØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ - Ù…Ø¯Ø®Ù„ Ø´Ù…Ø§Ù„ÙŠ", area: "college", status: "available", type: "regular", price: 10 },
            { id: 2, number: "C-02", location: "Ù…Ø¬Ø§ÙˆØ± ÙƒÙ„ÙŠØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ - Ù…Ø¯Ø®Ù„ Ø´Ù…Ø§Ù„ÙŠ", area: "college", status: "occupied", type: "regular", price: 10 },
            { id: 3, number: "U-01", location: "Ø£Ù…Ø§Ù… Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© - Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø£Ù‡Ù„ÙŠØ©", area: "uni", status: "available", type: "vip", price: 25 },
            { id: 4, number: "U-02", location: "Ù…ÙˆÙ‚Ù Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø£Ù‡Ù„ÙŠØ© - Ø·Ø§Ø¨Ù‚ 1", area: "uni", status: "available", type: "regular", price: 12 },
            { id: 5, number: "D-10", location: "Ù‚Ø±ÙŠØ¨ Ù…Ù† ÙƒØ§ÙÙŠÙ‡ Ø¯ÙŠØ³Ø¨Ø§Ø³ÙŠØªÙˆ - Ø´Ø§Ø±Ø¹ Ø§Ù„ÙƒØ§ÙÙŠÙ‡", area: "dispacito", status: "available", type: "regular", price: 15 },
            { id: 6, number: "D-11", location: "Ù‚Ø±ÙŠØ¨ Ù…Ù† ÙƒØ§ÙÙŠÙ‡ Ø¯ÙŠØ³Ø¨Ø§Ø³ÙŠØªÙˆ - Ø®Ù„Ù Ø§Ù„ÙƒØ§ÙÙŠÙ‡", area: "dispacito", status: "occupied", type: "vip", price: 20 },
            { id: 7, number: "O-05", location: "Ø£Ù…Ø§Ù… ÙƒØ§ÙÙŠÙ‡ ÙˆØ§Ø­Ø© Ø§Ù„Ø¨ÙƒØ±ÙŠ - Ù…ÙˆÙ‚Ù Ø®Ø§Ø±Ø¬ÙŠ", area: "oasis", status: "available", type: "regular", price: 14 },
            { id: 8, number: "O-06", location: "Ø®Ù„Ù ÙƒØ§ÙÙŠÙ‡ ÙˆØ§Ø­Ø© Ø§Ù„Ø¨ÙƒØ±ÙŠ - Ù…Ø¯Ø®Ù„ Ø¬Ø§Ù†Ø¨ÙŠ", area: "oasis", status: "maintenance", type: "disabled", price: 8 },
            { id: 9, number: "M-21", location: "Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© - Ø³ÙˆÙ‚ Ø§Ù„Ø®Ø¯Ù…Ø©", area: "central", status: "available", type: "regular", price: 11 },
            { id: 10, number: "M-22", location: "Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© - Ù…Ø¬Ù…Ø¹ Ø§Ù„Ù…ÙƒØ§ØªØ¨", area: "central", status: "occupied", type: "vip", price: 28 },
            { id: 11, number: "M-23", location: "Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© - Ø´Ø§Ø±Ø¹ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©", area: "central", status: "available", type: "regular", price: 12 },
            { id: 12, number: "V-01", location: "Ù…ÙˆÙ‚Ù Ù…Ù…ÙŠØ² Ø¨Ø¬ÙˆØ§Ø± Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø£Ù‡Ù„ÙŠØ© - VIP", area: "uni", status: "available", type: "vip", price: 35 }
        ];

        // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ù…ÙˆØ§Ù‚Ù ØªÙØ®Ø²Ù† Ù…Ø­Ù„ÙŠØ§ Ù„ØªØªØ°ÙƒÙ‘Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø®Ù„Ø§Ù„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª
        let parkingSlots = JSON.parse(localStorage.getItem('parking_slots')) || sampleSlots.slice();

        // Ø¹Ù†Ø§ØµØ± DOM
        const parkingGrid = document.getElementById('parkingGrid');
        const statTotal = document.getElementById('statTotal');
        const statAvailable = document.getElementById('statAvailable');
        const statOccupied = document.getElementById('statOccupied');
        const bookingsList = document.getElementById('bookingsList');
        const userBalanceEl = document.getElementById('userBalance');
        const userNameHeader = document.getElementById('userNameHeader');
        const userPlateHeader = document.getElementById('userPlateHeader');
        const locationsList = document.getElementById('locationsList');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const modalContent = document.getElementById('modalContent');
        const confirmBookingBtn = document.getElementById('confirmBookingBtn');
        const registerBackdrop = document.getElementById('registerBackdrop');
        const topupBackdrop = document.getElementById('topupBackdrop');

        // Ø­Ø§Ù„Ø© Ù…Ø¤Ù‚ØªØ© Ù„Ù„Ø­Ø¬Ø² Ø§Ù„Ø¬Ø§Ø±ÙŠ
        let selectedSlot = null;
        let selectedDuration = 1;
        let selectedPayment = 'wallet';

        /*******************
         * ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
         *******************/
        function initApp(){
            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            updateAuthUI();
            // Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ù‚Ù
            renderLocationsList();
            renderParkingSlots();
            renderBookings();
            applySearchListener();
            // Ø§Ø³ØªÙ…Ø¹ Ù„ØªØºÙŠÙ‘Ø± Ø§Ù„ÙÙ„Ø§ØªØ±
            document.getElementById('areaFilter').value = 'all';
            document.getElementById('typeFilter').value = 'all';
        }

        function updateAuthUI(){
            if(currentUser){
                userNameHeader.textContent = currentUser.name;
                userPlateHeader.textContent = currentUser.carPlate || 'Ù„Ù… ØªÙØ¯Ø®Ù„ Ù„ÙˆØ­Ø©';
                userBalanceEl.textContent = `${currentUser.balance ?? 0} Ø¬.Ù…`;
                document.getElementById('loginBtn').textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬';
                document.getElementById('loginBtn').onclick = logout;
                // ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù† Ù„Ø²Ù…
                localStorage.setItem('current_user', JSON.stringify(currentUser));
            }else{
                userNameHeader.textContent = 'Ø²Ø§Ø¦Ø±';
                userPlateHeader.textContent = 'Ù„Ù… ØªÙØ³Ø¬Ù„ Ø¨Ø¹Ø¯';
                userBalanceEl.textContent = `0 Ø¬.Ù…`;
                document.getElementById('loginBtn').textContent = 'Ø§Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ / ØªØ³Ø¬ÙŠÙ„';
                document.getElementById('loginBtn').onclick = showRegister;
                localStorage.removeItem('current_user');
            }
        }

        /*******************
         * Ø±Ù†Ø¯Ø± Ø§Ù„Ù…ÙˆØ§Ù‚Ù
         *******************/
        function renderParkingSlots(){
            // Ø·Ø¨Ù‚ Ø§Ù„ÙÙ„Ø§ØªØ±
            const area = document.getElementById('areaFilter').value || 'all';
            const type = document.getElementById('typeFilter').value || 'all';
            const query = document.getElementById('globalSearch').value?.trim().toLowerCase() || '';

            let filtered = parkingSlots.filter(slot => {
                if(area !== 'all' && slot.area !== area) return false;
                if(type !== 'all' && slot.type !== type) return false;
                if(query){
                    const q = query;
                    if(!(slot.number.toLowerCase().includes(q) || slot.location.toLowerCase().includes(q))) return false;
                }
                return true;
            });

            parkingGrid.innerHTML = '';
            filtered.forEach(slot => {
                const card = document.createElement('div');
                card.className = 'slot';

                let badgeClass = slot.status === 'available' ? 'available' : (slot.status === 'occupied' ? 'occupied' : 'maintenance');
                let typeBadge = slot.type === 'vip' ? 'vip' : '';

                card.innerHTML = `
                    <div class="slot-head">
                        <div>
                            <div class="slot-number">${slot.number}</div>
                            <small class="muted">${slot.location}</small>
                        </div>
                        <div style="text-align:left">
                            <div style="display:flex; gap:8px; align-items:center; justify-content:flex-end;">
                                <div class="badge ${badgeClass}">${slot.status === 'available' ? 'Ù…ØªØ§Ø­' : slot.status === 'occupied' ? 'Ù…Ø­Ø¬ÙˆØ²' : 'ØµÙŠØ§Ù†Ø©'}</div>
                                ${slot.type === 'vip' ? '<div class="badge vip">Ù…Ù…ÙŠØ²</div>' : ''}
                            </div>
                        </div>
                    </div>

                    <div class="slot-body">
                        <div style="display:flex; justify-content:space-between; align-items:center">
                            <div class="price">${slot.price} Ø¬.Ù… / Ø³Ø§Ø¹Ø©</div>
                            <div class="muted">Ù†ÙˆØ¹: ${slot.type === 'regular' ? 'Ø¹Ø§Ø¯ÙŠ' : slot.type === 'disabled' ? 'Ø°ÙˆÙŠ Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª' : 'Ù…Ù…ÙŠØ²'}</div>
                        </div>
                    </div>

                    <div class="slot-actions">
                        ${slot.status === 'available' ? `<button class="btn-block btn-book" onclick="openBookingModal(${slot.id})">Ø§Ø­Ø¬Ø² Ø§Ù„Ø¢Ù†</button>` : `<button class="btn-block btn-disabled" disabled>ØºÙŠØ± Ù…ØªØ§Ø­</button>`}
                        <button class="btn-block" onclick="viewSlotDetails(${slot.id})">ØªÙØ§ØµÙŠÙ„</button>
                    </div>
                `;
                parkingGrid.appendChild(card);
            });

            // Ø¥Ø­ØµØ§Ø¡Ø§Øª
            statTotal.textContent = `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${parkingSlots.length}`;
            statAvailable.textContent = `Ù…ØªØ§Ø­: ${parkingSlots.filter(s=>s.status==='available').length}`;
            statOccupied.textContent = `Ù…Ø­Ø¬ÙˆØ²: ${parkingSlots.filter(s=>s.status==='occupied').length}`;
            localStorage.setItem('parking_slots', JSON.stringify(parkingSlots));
        }

        /*******************
         * Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹
         *******************/
        function renderLocationsList(){
            const areas = [
                {key:'college', title:'ÙƒÙ„ÙŠØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ', desc:'Ù…ÙˆØ§Ù‚Ù Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ÙƒÙ„ÙŠØ©'},
                {key:'uni', title:'Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø£Ù‡Ù„ÙŠØ©', desc:'Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© Ùˆ Ø§Ù„Ù…ÙˆØ§Ù‚Ù Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©'},
                {key:'dispacito', title:'ÙƒØ§ÙÙŠÙ‡ Ø¯ÙŠØ³Ø¨Ø§Ø³ÙŠØªÙˆ', desc:'Ø´Ø§Ø±Ø¹ Ø§Ù„Ù…Ù‚Ø§Ù‡ÙŠ ÙˆØ§Ù„Ù…Ø·Ø§Ø¹Ù…'},
                {key:'oasis', title:'ÙƒØ§ÙÙŠÙ‡ ÙˆØ§Ø­Ø© Ø§Ù„Ø¨ÙƒØ±ÙŠ', desc:'Ù…ÙˆØ§Ù‚Ù Ù…Ø®ØµØµØ© Ù„Ù„ÙƒØ§ÙÙŠÙ‡'},
                {key:'central', title:'Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©', desc:'Ù…Ø±ÙƒØ² Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ùˆ Ø§Ù„Ù…ÙƒØ§ØªØ¨'}
            ];

            locationsList.innerHTML = '';
            areas.forEach(a=>{
                const el = document.createElement('div');
                el.className = 'loc-item';
                el.innerHTML = `<div>
                                    <div style="font-weight:800">${a.title}</div>
                                    <small class="muted">${a.desc}</small>
                                </div>
                                <div style="display:flex; gap:8px; align-items:center">
                                    <button class="btn ghost" onclick="filterByArea('${a.key}')">Ø¹Ø±Ø¶</button>
                                    <div class="muted">${parkingSlots.filter(s=>s.area===a.key).length} Ù…ÙˆÙ‚Ù</div>
                                </div>`;
                locationsList.appendChild(el);
            });
        }

        function filterByArea(areaKey){
            document.getElementById('areaFilter').value = areaKey;
            applyFilters();
        }

        function applyFilters(){
            renderParkingSlots();
        }

        /*******************
         * Ø§Ù„Ø¨Ø­Ø«
         *******************/
        function applySearchListener(){
            document.getElementById('globalSearch').addEventListener('input', function(){
                renderParkingSlots();
            });
        }

        /*******************
         * Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆÙ‚Ù
         *******************/
        function openBookingModal(slotId){
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ â€” Ù†Ø·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹
            if(!currentUser){
                showRegister();
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø£Ùˆ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø¬Ø².');
                return;
            }

            selectedSlot = parkingSlots.find(s => s.id === slotId);
            selectedDuration = 1;
            selectedPayment = 'wallet';

            modalContent.innerHTML = `
                <div style="display:flex; flex-direction:column; gap:8px">
                    <div><strong>Ø§Ù„Ù…ÙˆÙ‚Ù:</strong> ${selectedSlot.number} â€” <span class="muted">${selectedSlot.location}</span></div>
                    <div><strong>Ø§Ù„Ø³Ø¹Ø±/Ø³Ø§Ø¹Ø©:</strong> ${selectedSlot.price} Ø¬.Ù…</div>

                    <label class="muted">Ù…Ø¯Ø© Ø§Ù„Ø­Ø¬Ø² (Ø³Ø§Ø¹Ø§Øª)</label>
                    <select id="bookingDuration" class="form-control" onchange="onDurationChange(this.value)">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="8">8</option>
                        <option value="24">24</option>
                    </select>

                    <label class="muted">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                    <select id="bookingPayment" class="form-control" onchange="onPaymentChange(this.value)">
                        <option value="wallet">Ø§Ù„Ù…Ø­ÙØ¸Ø©</option>
                        <option value="card">Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†</option>
                        <option value="cash">Ù†Ù‚Ø¯ÙŠ</option>
                    </select>

                    <div class="muted">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="bookingTotal">${selectedSlot.price} Ø¬.Ù…</span></div>

                    <div class="qr-box" id="qrPreview" style="display:none">
                        <div style="font-weight:800">QR Code (Ø­Ø¬ÙˆØ²ØªÙƒ)</div>
                        <small class="muted">Ø§Ø¹Ø±Ø¶Ù‡ Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„Ø®Ø±ÙˆØ¬</small>
                        <div id="qrText" style="margin-top:8px; font-weight:700; word-break:break-all"></div>
                    </div>
                </div>
            `;

            // Ø±Ø¨Ø· Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø¨Ø­ÙŠØ« ÙŠØªØºÙŠØ± Ø§Ù„Ø³Ù„ÙˆÙƒ Ø¨Ø­Ø³Ø¨ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
            confirmBookingBtn.disabled = false;
            modalBackdrop.style.display = 'flex';
        }

        function onDurationChange(val){
            selectedDuration = parseInt(val);
            updateBookingTotal();
        }

        function onPaymentChange(val){
            selectedPayment = val;
            updateBookingTotal();
        }

        function updateBookingTotal(){
            if(!selectedSlot) return;
            const total = selectedSlot.price * selectedDuration;
            document.getElementById('bookingTotal').textContent = `${total} Ø¬.Ù…`;
        }

        function confirmBooking(){
            if(!currentUser || !selectedSlot) return;

            const totalAmount = selectedSlot.price * selectedDuration;

            if(selectedPayment === 'wallet'){
                if((currentUser.balance ?? 0) < totalAmount){
                    alert('Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø© ØºÙŠØ± ÙƒØ§ÙÙ. ÙŠÙ…ÙƒÙ†Ùƒ Ø´Ø­Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø£Ùˆ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø¯ÙØ¹ Ø£Ø®Ø±Ù‰.');
                    return;
                }
                // Ø®ØµÙ…
                currentUser.balance = (currentUser.balance ?? 0) - totalAmount;
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
                const idx = users.findIndex(u=>u.id === currentUser.id);
                if(idx !== -1) users[idx].balance = currentUser.balance;
                localStorage.setItem('parking_users', JSON.stringify(users));
                localStorage.setItem('current_user', JSON.stringify(currentUser));
            }

            // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø§Ù„Ø­Ø¬Ø²
            const bookingCode = `EGP-${Date.now()}-${Math.floor(Math.random()*9000+1000)}`;
            const newBooking = {
                id: Date.now(),
                userId: currentUser.id,
                slotId: selectedSlot.id,
                slotNumber: selectedSlot.number,
                duration: selectedDuration,
                totalAmount: totalAmount,
                paymentMethod: selectedPayment,
                status: 'active',
                createdAt: new Date().toISOString(),
                qrCode: bookingCode
            };
            bookings.push(newBooking);
            localStorage.setItem('parking_bookings', JSON.stringify(bookings));

            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆÙ‚Ù
            const si = parkingSlots.findIndex(s=>s.id===selectedSlot.id);
            if(si !== -1) parkingSlots[si].status = 'occupied';
            localStorage.setItem('parking_slots', JSON.stringify(parkingSlots));

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            renderParkingSlots();
            renderBookings();
            updateAuthUI();

            // Ø¹Ø±Ø¶ QR Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
            const qrBox = document.getElementById('qrPreview');
            const qrText = document.getElementById('qrText');
            qrBox.style.display = 'block';
            qrText.textContent = newBooking.qrCode;

            confirmBookingBtn.disabled = true;
            confirmBookingBtn.textContent = 'ØªÙ… Ø§Ù„Ø­Ø¬Ø²';
            setTimeout(()=>{ closeModal(); confirmBookingBtn.textContent = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²'; confirmBookingBtn.disabled = false }, 1200);
            alert(`ØªÙ… Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­ â€” Ø§Ù„Ù…Ø¨Ù„Øº: ${totalAmount} Ø¬.Ù…\nØ±Ù…Ø² Ø§Ù„Ø­Ø¬Ø²: ${newBooking.qrCode}`);
        }

        function closeModal(){
            modalBackdrop.style.display = 'none';
            selectedSlot = null;
        }

        function viewSlotDetails(slotId){
            const slot = parkingSlots.find(s=>s.id===slotId);
            if(!slot) return;
            alert(`ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ù:\n\nØ§Ù„Ø±Ù‚Ù…: ${slot.number}\nØ§Ù„Ù…ÙˆÙ‚Ø¹: ${slot.location}\nØ§Ù„Ù†ÙˆØ¹: ${slot.type}\nØ§Ù„Ø³Ø¹Ø±: ${slot.price} Ø¬.Ù… / Ø³Ø§Ø¹Ø©\nØ§Ù„Ø­Ø§Ù„Ø©: ${slot.status}`);
        }

        /*******************
         * Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ùˆ Ø§Ù„Ø¹Ø±Ø¶
         *******************/
        function renderBookings(){
            bookingsList.innerHTML = '';
            const recent = bookings.slice().reverse().slice(0,6);
            if(recent.length === 0){
                bookingsList.innerHTML = `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</div>`;
            }else{
                recent.forEach(b=>{
                    const item = document.createElement('div');
                    item.className = 'booking-item';
                    const slot = parkingSlots.find(s=>s.id===b.slotId) || {number:b.slotNumber};
                    item.innerHTML = `<div style="display:flex; flex-direction:column">
                                            <div style="font-weight:800">${slot.number}</div>
                                            <small class="muted">${new Date(b.createdAt).toLocaleString()}</small>
                                        </div>
                                        <div style="text-align:left">
                                            <div style="font-weight:800">${b.totalAmount} Ø¬.Ù…</div>
                                            <small class="muted">${b.status} â€” ${b.paymentMethod}</small>
                                            <div style="margin-top:6px; display:flex; gap:6px; justify-content:flex-end">
                                                <button class="btn ghost" onclick="showBookingQR('${b.qrCode}')">Ø¹Ø±Ø¶ QR</button>
                                                <button class="btn" onclick="cancelBooking(${b.id})">Ø¥Ù„ØºØ§Ø¡</button>
                                            </div>
                                        </div>`;
                    bookingsList.appendChild(item);
                });
            }
        }

        function viewMyBookings(){
            // ÙØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª (Ù†ÙØ³ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©)
            alert('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø¸Ø§Ù‡Ø±Ø© Ø£Ø³ÙÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ù (Ø¢Ø®Ø± Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª).');
        }

        function showBookingQR(code){
            alert(`Ø±Ù…Ø² Ø§Ù„Ø­Ø¬Ø²:\n\n${code}\n\nØ§Ø¹Ø±Ø¶ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² Ø¹Ù†Ø¯ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©`);
        }

        function cancelBooking(bookingId){
            const i = bookings.findIndex(b=>b.id===bookingId && b.status==='active');
            if(i === -1){
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¬Ø² Ù†Ø´Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…');
                return;
            }
            // Ø¥Ù„ØºØ§Ø¡ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº Ø¥Ù† ÙƒØ§Ù† Ù…Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©
            const b = bookings[i];
            b.status = 'cancelled';
            bookings[i] = b;
            // ØªØ­Ø±ÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ù
            const si = parkingSlots.findIndex(s=>s.id===b.slotId);
            if(si !== -1) parkingSlots[si].status = 'available';

            // Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„Ù…Ø­ÙØ¸Ø© Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ø¯ÙØ¹ Ø¨Ø§Ù„Ù…Ø­ÙØ¸Ø©
            if(b.paymentMethod === 'wallet'){
                const uidx = users.findIndex(u=>u.id === b.userId);
                if(uidx !== -1){
                    users[uidx].balance = (users[uidx].balance ?? 0) + b.totalAmount;
                    if(currentUser && currentUser.id === users[uidx].id){
                        currentUser.balance = users[uidx].balance;
                        localStorage.setItem('current_user', JSON.stringify(currentUser));
                    }
                }
            }

            localStorage.setItem('parking_bookings', JSON.stringify(bookings));
            localStorage.setItem('parking_slots', JSON.stringify(parkingSlots));
            localStorage.setItem('parking_users', JSON.stringify(users));

            renderParkingSlots();
            renderBookings();
            updateAuthUI();
            alert('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø² ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº (Ø¥Ù† ÙˆÙØ¬Ø¯ Ù…Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©).');
        }

        /*******************
         * ØªØ³Ø¬ÙŠÙ„ / Ø´Ø­Ù† Ù…Ø­ÙØ¸Ø©
         *******************/
        function showRegister(){
            registerBackdrop.style.display = 'flex';
        }

        function closeRegister(){
            registerBackdrop.style.display = 'none';
        }

        function submitRegister(){
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const plate = document.getElementById('regPlate').value.trim();
            const pwd = document.getElementById('regPassword').value.trim();
            if(!name || !email || !pwd){
                alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ØŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±).');
                return;
            }
            if(users.find(u=>u.email === email)){
                alert('Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…ÙØ³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ø­Ø§ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.');
                return;
            }
            const newUser = {
                id: Date.now(),
                name, email, password: pwd, carPlate: plate, balance: 200 // Ø±ØµÙŠØ¯ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ ØªØ´Ø¬ÙŠØ¹ÙŠ
            };
            users.push(newUser);
            localStorage.setItem('parking_users', JSON.stringify(users));
            currentUser = newUser;
            localStorage.setItem('current_user', JSON.stringify(currentUser));
            updateAuthUI();
            closeRegister();
            alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ØªÙ… Ø¥Ø¶Ø§ÙØ© 200 Ø¬.Ù… Ø±ØµÙŠØ¯ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ.');
            renderBookings();
        }

        function logout(){
            if(confirm('Ù‡Ù„ ØªØ±ØºØ¨ Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')){
                currentUser = null;
                updateAuthUI();
            }
        }

        function showTopUp(){
            if(!currentUser){ showRegister(); alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹'); return; }
            topupBackdrop.style.display = 'flex';
        }

        function closeTopUp(){ topupBackdrop.style.display = 'none'; }

        function submitTopUp(){
            const amount = parseFloat(document.getElementById('topupAmount').value);
            if(isNaN(amount) || amount <= 0){ alert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºÙ‹Ø§ ØµØ­ÙŠØ­Ù‹Ø§ Ù„Ù„Ø´Ø­Ù†'); return; }
            const idx = users.findIndex(u=>u.id===currentUser.id);
            if(idx !== -1){
                users[idx].balance = (users[idx].balance ?? 0) + amount;
                currentUser.balance = users[idx].balance;
                localStorage.setItem('parking_users', JSON.stringify(users));
                localStorage.setItem('current_user', JSON.stringify(currentUser));
                updateAuthUI();
                closeTopUp();
                alert(`ØªÙ… Ø´Ø­Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø¨Ù…Ù‚Ø¯Ø§Ø± ${amount} Ø¬.Ù…`);
            } else alert('Ø­Ø¯Ø« Ø®Ø·Ø£: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        }

        /*******************
         * Ø¹Ù†Ø§ØµØ± Ù…Ø³Ø§Ø¹Ø¯Ø©
         *******************/
        function toggleFilterPanel(){
            const left = document.getElementById('leftPanel');
            left.style.display = left.style.display === 'none' ? 'block' : 'none';
        }

        function showBookingQR(code){
            alert('Ø±Ù…Ø² Ø§Ù„Ø­Ø¬Ø²:\n\n' + code);
        }

        // ØªÙ‡ÙŠØ¦Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        window.addEventListener('DOMContentLoaded', initApp);

        // Ø§Ø³ØªÙ…Ø¹ Ø¥Ù„Ù‰ ØªØºÙŠÙ‘Ø± Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø¹Ø§Ù… Ùˆ ØªØ­Ø¯ÙŠØ«
        document.getElementById('areaFilter').addEventListener('change', renderParkingSlots);
        document.getElementById('typeFilter').addEventListener('change', renderParkingSlots);

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥ÙØªØ±Ø§Ø¶ÙŠ (Ø¥Ù† Ù„Ù… ÙŠÙˆØ¬Ø¯)
        if(!currentUser && users.length > 0){
            // Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¦Ù‹Ø§ - Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¨Ù‚Ù‰ Ø²Ø§Ø¦Ø± Ø­ØªÙ‰ ÙŠÙØ³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        }

        /*******************
         * Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®ÙÙŠÙØ©:
         * - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡ Ø§Ù„Ù…ØµØ±ÙŠ (Ø¬.Ù…).
         * - ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø´Ø­Ù† Ù…Ø­ÙØ¸Ø©ØŒ Ø¥Ø¯Ø§Ø±Ø© Ø­Ø¬ÙˆØ²Ø§Øª (Ø¥Ù„ØºØ§Ø¡ØŒ Ø¹Ø±Ø¶ QR)ØŒ ÙˆÙÙ„Ø§ØªØ± Ù„Ù„Ù…ÙˆØ§Ù‚Ø¹.
         * - ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© stored ÙÙŠ localStorage ØªØ­Øª Ù…ÙØ§ØªÙŠØ­:
         *     parking_slots, parking_users, parking_bookings, current_user
         *******************/
    </script>
</body>
</html>

