<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>نظام المواقف الذكي — Smart Parking (EGP)</title>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root{
            --bg: #f6f8fb;
            --card: #ffffff;
            --muted: #7b8aa3;
            --accent: #1652f0; /* primary */
            --accent-2: #06b39a; /* success/green */
            --danger: #ff4d6d;
            --warning: #f39c12;
            --glass: rgba(255,255,255,0.6);
            --shadow: 0 8px 28px rgba(14,30,37,0.06);
            --radius: 12px;
            --text: #0f1724;
            --egp: "جنيه";
        }

        *{box-sizing:border-box}
        html,body{height:100%}
        body{
            margin:0;
            font-family: 'Inter', Arial, sans-serif;
            background: linear-gradient(180deg,#f6f8fb 0%, #eef3fb 100%);
            color:var(--text);
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            direction: rtl;
        }

        /* App container */
        .app {
            min-height:100vh;
            display:flex;
            flex-direction:column;
        }

        /* Top header */
        .header {
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:18px 28px;
            gap:16px;
            background:linear-gradient(90deg, rgba(22,82,240,1) 0%, rgba(6,179,154,1) 100%);
            color:white;
            box-shadow: 0 6px 22px rgba(13,37,71,0.12);
        }

        .brand {
            display:flex;
            gap:12px;
            align-items:center;
        }

        .brand .logo {
            width:46px;
            height:46px;
            border-radius:10px;
            background:rgba(255,255,255,0.12);
            display:flex;
            align-items:center;
            justify-content:center;
            font-weight:800;
            font-size:20px;
            box-shadow: inset 0 -4px 12px rgba(0,0,0,0.06);
        }

        .brand h1{
            font-size:18px;
            margin:0;
            line-height:1;
        }

        .brand p{
            margin:0;
            font-size:12px;
            opacity:0.95;
        }

        .header-actions {
            display:flex;
            align-items:center;
            gap:14px;
        }

        .search {
            background: rgba(255,255,255,0.12);
            border-radius:10px;
            padding:8px;
            display:flex;
            gap:8px;
            align-items:center;
            min-width:280px;
            color:white;
        }

        .search input{
            background:transparent;
            border:0;
            outline:0;
            color:white;
            width:100%;
            font-size:14px;
        }

        .btn {
            border:0;
            padding:10px 14px;
            border-radius:10px;
            cursor:pointer;
            font-weight:600;
            display:inline-flex;
            align-items:center;
            gap:8px;
            transition:all .18s ease;
            box-shadow:none;
        }

        .btn.ghost {
            background: rgba(255,255,255,0.12);
            color: white;
        }

        .btn.primary {
            background: white;
            color: var(--accent);
        }

        .btn.success {
            background: var(--accent-2);
            color: white;
        }

        .user-card {
            background: rgba(255,255,255,0.08);
            padding:8px 10px;
            border-radius:10px;
            display:flex;
            gap:8px;
            align-items:center;
            color:white;
        }

        .user-card img{
            width:36px;
            height:36px;
            border-radius:10px;
            object-fit:cover;
            border:2px solid rgba(255,255,255,0.12);
        }

        /* Main content area */
        .container {
            max-width:1200px;
            margin:22px auto;
            width:calc(100% - 40px);
            display:grid;
            grid-template-columns: 360px 1fr;
            gap:20px;
            align-items:start;
        }

        /* Left panel */
        .panel {
            background:var(--card);
            border-radius:var(--radius);
            padding:18px;
            box-shadow:var(--shadow);
        }

        .panel h3 { margin:0 0 12px 0; font-size:16px; }
        .balance {
            display:flex;
            flex-direction:column;
            gap:6px;
            padding:12px;
            border-radius:10px;
            background: linear-gradient(90deg, rgba(6,179,154,0.06), rgba(22,82,240,0.04));
            border:1px solid rgba(15,23,36,0.03);
        }
        .balance .amount {
            font-weight:800;
            font-size:20px;
            color:var(--accent);
        }
        .balance small{ color:var(--muted) }

        .filter-group { margin-top:14px; display:flex; flex-direction:column; gap:10px; }
        select.form-control, input.form-control {
            padding:10px 12px;
            border-radius:8px;
            border:1px solid #e7eef8;
            font-size:14px;
        }

        .locations-list { margin-top:14px; display:flex; flex-direction:column; gap:10px; }
        .loc-item {
            display:flex;
            justify-content:space-between;
            gap:10px;
            padding:10px;
            border-radius:8px;
            align-items:center;
            background: linear-gradient(180deg,#fff,#fbfdff);
            border:1px solid #f0f5fb;
        }
        .loc-item small { color:var(--muted); font-size:13px }

        .actions-row { margin-top:12px; display:flex; gap:8px; }

        /* Right panel (grid) */
        .grid-area {
            display:flex;
            flex-direction:column;
            gap:14px;
        }

        .topbar {
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:12px;
        }

        .stats {
            display:flex;
            gap:12px;
            align-items:center;
        }

        .stat {
            background: linear-gradient(180deg,#fff,#fbfdff);
            border-radius:10px;
            padding:10px 12px;
            box-shadow: var(--shadow);
            border:1px solid #f0f5fb;
            display:flex;
            align-items:center;
            gap:10px;
            font-weight:700;
            min-width:110px;
        }

        .parking-grid {
            display:grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap:16px;
        }

        .slot {
            background: linear-gradient(180deg,#fff,#fcfeff);
            border-radius:12px;
            padding:12px;
            box-shadow:var(--shadow);
            border:1px solid #eef6ff;
            display:flex;
            flex-direction:column;
            gap:10px;
            transition:transform .18s ease, box-shadow .18s ease;
        }

        .slot:hover { transform:translateY(-6px); box-shadow: 0 18px 40px rgba(14,30,37,0.08) }

        .slot-head {
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:10px;
        }

        .slot-number {
            font-weight:800;
            font-size:15px;
        }

        .badge {
            padding:6px 8px;
            border-radius:999px;
            font-weight:700;
            font-size:12px;
            color:white;
        }

        .badge.available { background: var(--accent-2) }
        .badge.occupied { background: var(--danger) }
        .badge.maintenance { background: #6b6f76 }
        .badge.vip { background: linear-gradient(90deg,#d97706,#f59e0b) }

        .slot-body small { color:var(--muted) }

        .price {
            font-weight:800;
            font-size:16px;
            color:var(--accent);
        }

        .slot-actions {
            display:flex;
            gap:8px;
            margin-top:8px;
        }

        .btn-block {
            flex:1;
            padding:10px;
            border-radius:10px;
            border:0;
            font-weight:700;
            cursor:pointer;
        }

        .btn-book { background:linear-gradient(90deg,var(--accent-2),#08a07f); color:white }
        .btn-disabled { background:#eef2f6; color:var(--muted); cursor:not-allowed }

        /* Booking modal */
        .modal-backdrop {
            display:none;
            position:fixed;
            inset:0;
            background: rgba(6,13,31,0.45);
            z-index:1200;
            align-items:center;
            justify-content:center;
            padding:20px;
        }

        .modal {
            width:100%;
            max-width:560px;
            background:white;
            border-radius:12px;
            padding:18px;
            box-shadow: 0 20px 60px rgba(7,19,41,0.35);
        }

        .modal h3{ margin:0 0 12px 0 }
        .form-row { display:flex; gap:8px; align-items:center }
        .form-row > * { flex:1 }

        .qr-box {
            border-radius:10px;
            padding:12px;
            border:1px dashed #e6eefb;
            text-align:center;
        }

        /* bookings list */
        .bookings-list { margin-top:12px; display:flex; flex-direction:column; gap:10px }
        .booking-item {
            display:flex;
            justify-content:space-between;
            gap:8px;
            padding:10px;
            border-radius:8px;
            background:#fff;
            border:1px solid #f0f5fb;
            align-items:center;
        }

        /* responsive */
        @media (max-width: 980px){
            .container { grid-template-columns: 1fr; width:calc(100% - 32px) }
            .search { min-width:unset }
            .header { padding:14px }
        }

        /* small helper */
        .muted { color:var(--muted); font-size:13px }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="brand">
                <div class="logo">🅿️</div>
                <div>
                    <h1>Smart Parking — نظام المواقف الذكي</h1>
                    <p>كهربة الحجز و إدارة المواقف — العملة: جنيه مصري (EGP)</p>
                </div>
            </div>

            <div class="header-actions">
                <div class="search" title="ابحث عن رقم الموقف أو اسم الموقع">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="opacity:.9">
                        <path d="M21 21l-4.35-4.35" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="11" cy="11" r="6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <input id="globalSearch" placeholder="ابحث عن موقف، موقع، أو رقم اللوحة..." />
                </div>

                <button class="btn ghost" onclick="toggleFilterPanel()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="opacity:.95">
                        <path d="M22 7H2" stroke="white" stroke-width="2" stroke-linecap="round"/><path d="M6 12h12" stroke="white" stroke-width="2" stroke-linecap="round"/><path d="M10 17h4" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    فرز/تصفية
                </button>

                <div class="user-card" id="authArea">
                    <img src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=400&auto=format&fit=crop&ixlib=rb-4.0.3&s=1e5a3d737c5f1b3f9e3d4b0c0c8b6f14" alt="avatar" />
                    <div>
                        <div style="font-weight:800" id="userNameHeader">زائر</div>
                        <small class="muted" id="userPlateHeader">لم تُسجل بعد</small>
                    </div>
                </div>

                <button class="btn primary" id="loginBtn" onclick="showRegister()">انشاء حساب / تسجيل</button>
            </div>
        </header>

        <!-- Main layout -->
        <main class="container">
            <!-- left panel -->
            <aside class="panel" id="leftPanel">
                <h3>حسابك & تصفية المواقع</h3>

                <div class="balance" style="margin-top:8px">
                    <div class="muted">الرصيد الحالي</div>
                    <div class="amount" id="userBalance">-- ج.م</div>
                    <small class="muted">يمكنك شحن المحفظة أو الدفع نقداً عند الاستلام</small>
                </div>

                <div class="filter-group">
                    <label class="muted">الموقع القريب</label>
                    <select id="areaFilter" class="form-control" onchange="applyFilters()">
                        <option value="all">كل المواقع</option>
                        <option value="college">كلية التعليم الصناعي</option>
                        <option value="uni">الجامعة الأهلية</option>
                        <option value="dispacito">كافيه ديسباسيتو</option>
                        <option value="oasis">كافيه واحة البكري</option>
                        <option value="central">المنطقة المركزية</option>
                    </select>

                    <label class="muted">نوع الموقف</label>
                    <select id="typeFilter" class="form-control" onchange="applyFilters()">
                        <option value="all">كل الأنواع</option>
                        <option value="regular">عادي</option>
                        <option value="vip">مميز</option>
                        <option value="disabled">ذوي احتياجات</option>
                    </select>

                    <div class="actions-row">
                        <button class="btn success" onclick="showTopUp()" style="width:100%">شحن المحفظة</button>
                        <button class="btn ghost" onclick="viewMyBookings()" style="width:100%">حجوزاتي</button>
                    </div>
                </div>

                <div style="margin-top:14px">
                    <h3 style="font-size:14px; margin-bottom:8px">المواقع القريبة</h3>
                    <div class="locations-list" id="locationsList">
                        <!-- populated by JS -->
                    </div>
                </div>
            </aside>

            <!-- right panel -->
            <section class="grid-area">
                <div class="topbar">
                    <div>
                        <h2 style="margin:0">المواقف المتاحة</h2>
                        <small class="muted">اختر الموقف الأقرب أو الأنسب لك — الأسعار بالجنيه المصري (EGP/ساعة)</small>
                    </div>

                    <div class="stats">
                        <div class="stat" id="statTotal">المجموع: 0</div>
                        <div class="stat" id="statAvailable">متاح: 0</div>
                        <div class="stat" id="statOccupied">محجوز: 0</div>
                    </div>
                </div>

                <div class="parking-grid" id="parkingGrid">
                    <!-- slot cards injected by JS -->
                </div>

                <!-- my bookings list (for mobile/quick view) -->
                <div class="panel" id="recentBookingsPanel" style="margin-top:14px">
                    <h3>آخر الحجوزات</h3>
                    <div class="bookings-list" id="bookingsList">
                        <!-- injected -->
                    </div>
                </div>
            </section>
        </main>

        <!-- Booking Modal -->
        <div class="modal-backdrop" id="modalBackdrop">
            <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
                <h3 id="modalTitle">حجز موقف</h3>
                <div id="modalContent">
                    <!-- injected -->
                </div>

                <div style="display:flex; gap:8px; margin-top:12px">
                    <button class="btn btn-block btn-book" id="confirmBookingBtn" onclick="confirmBooking()">تأكيد الحجز</button>
                    <button class="btn btn-block" onclick="closeModal()">إلغاء</button>
                </div>
            </div>
        </div>

        <!-- Simple top-up / register modal (re-uses backdrop) -->
        <div class="modal-backdrop" id="registerBackdrop" style="display:none">
            <div class="modal">
                <h3 id="registerTitle">إنشاء حساب / شحن المحفظة</h3>
                <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px">
                    <input id="regName" class="form-control" placeholder="الاسم الكامل (مطلو ب)"/>
                    <input id="regEmail" class="form-control" placeholder="البريد الإلكتروني"/>
                    <input id="regPlate" class="form-control" placeholder="رقم لوحة السيارة"/>
                    <input id="regPassword" type="password" class="form-control" placeholder="كلمة المرور"/>
                    <div style="display:flex; gap:8px">
                        <button class="btn primary" onclick="submitRegister()">إنشاء حساب</button>
                        <button class="btn ghost" onclick="closeRegister()">إلغاء</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top-up modal -->
        <div class="modal-backdrop" id="topupBackdrop" style="display:none">
            <div class="modal">
                <h3>شحن المحفظة</h3>
                <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px">
                    <input id="topupAmount" class="form-control" placeholder="المبلغ بالجنيه (مثال: 100)"/>
                    <div style="display:flex; gap:8px">
                        <button class="btn success" onclick="submitTopUp()">شحن الآن</button>
                        <button class="btn ghost" onclick="closeTopUp()">إلغاء</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        /***************
         * بيانات التطبيق
         ***************/
        let currentUser = JSON.parse(localStorage.getItem('current_user')) || null;
        let users = JSON.parse(localStorage.getItem('parking_users')) || [];
        let bookings = JSON.parse(localStorage.getItem('parking_bookings')) || [];

        // قائمة المواقف — أضفت 12 موقفًا بمواقع قريبة من الأماكن المطلوبة
        const sampleSlots = [
            { id: 1, number: "C-01", location: "مجاور كلية التعليم الصناعي - مدخل شمالي", area: "college", status: "available", type: "regular", price: 10 },
            { id: 2, number: "C-02", location: "مجاور كلية التعليم الصناعي - مدخل شمالي", area: "college", status: "occupied", type: "regular", price: 10 },
            { id: 3, number: "U-01", location: "أمام البوابة الرئيسية - الجامعة الأهلية", area: "uni", status: "available", type: "vip", price: 25 },
            { id: 4, number: "U-02", location: "موقف الجامعة الأهلية - طابق 1", area: "uni", status: "available", type: "regular", price: 12 },
            { id: 5, number: "D-10", location: "قريب من كافيه ديسباسيتو - شارع الكافيه", area: "dispacito", status: "available", type: "regular", price: 15 },
            { id: 6, number: "D-11", location: "قريب من كافيه ديسباسيتو - خلف الكافيه", area: "dispacito", status: "occupied", type: "vip", price: 20 },
            { id: 7, number: "O-05", location: "أمام كافيه واحة البكري - موقف خارجي", area: "oasis", status: "available", type: "regular", price: 14 },
            { id: 8, number: "O-06", location: "خلف كافيه واحة البكري - مدخل جانبي", area: "oasis", status: "maintenance", type: "disabled", price: 8 },
            { id: 9, number: "M-21", location: "المنطقة المركزية - سوق الخدمة", area: "central", status: "available", type: "regular", price: 11 },
            { id: 10, number: "M-22", location: "المنطقة المركزية - مجمع المكاتب", area: "central", status: "occupied", type: "vip", price: 28 },
            { id: 11, number: "M-23", location: "المنطقة المركزية - شارع الجامعة", area: "central", status: "available", type: "regular", price: 12 },
            { id: 12, number: "V-01", location: "موقف مميز بجوار الجامعة الأهلية - VIP", area: "uni", status: "available", type: "vip", price: 35 }
        ];

        // الحالة الحالية للمواقف تُخزن محليا لتتذكّر التعديلات خلال الجلسات
        let parkingSlots = JSON.parse(localStorage.getItem('parking_slots')) || sampleSlots.slice();

        // عناصر DOM
        const parkingGrid = document.getElementById('parkingGrid');
        const statTotal = document.getElementById('statTotal');
        const statAvailable = document.getElementById('statAvailable');
        const statOccupied = document.getElementById('statOccupied');
        const bookingsList = document.getElementById('bookingsList');
        const userBalanceEl = document.getElementById('userBalance');
        const userNameHeader = document.getElementById('userNameHeader');
        const userPlateHeader = document.getElementById('userPlateHeader');
        const locationsList = document.getElementById('locationsList');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const modalContent = document.getElementById('modalContent');
        const confirmBookingBtn = document.getElementById('confirmBookingBtn');
        const registerBackdrop = document.getElementById('registerBackdrop');
        const topupBackdrop = document.getElementById('topupBackdrop');

        // حالة مؤقتة للحجز الجاري
        let selectedSlot = null;
        let selectedDuration = 1;
        let selectedPayment = 'wallet';

        /*******************
         * تهيئة الواجهة
         *******************/
        function initApp(){
            // عرض المستخدم
            updateAuthUI();
            // عرض المواقف
            renderLocationsList();
            renderParkingSlots();
            renderBookings();
            applySearchListener();
            // استمع لتغيّر الفلاتر
            document.getElementById('areaFilter').value = 'all';
            document.getElementById('typeFilter').value = 'all';
        }

        function updateAuthUI(){
            if(currentUser){
                userNameHeader.textContent = currentUser.name;
                userPlateHeader.textContent = currentUser.carPlate || 'لم تُدخل لوحة';
                userBalanceEl.textContent = `${currentUser.balance ?? 0} ج.م`;
                document.getElementById('loginBtn').textContent = 'تسجيل خروج';
                document.getElementById('loginBtn').onclick = logout;
                // تحميل من المستخدم إن لزم
                localStorage.setItem('current_user', JSON.stringify(currentUser));
            }else{
                userNameHeader.textContent = 'زائر';
                userPlateHeader.textContent = 'لم تُسجل بعد';
                userBalanceEl.textContent = `0 ج.م`;
                document.getElementById('loginBtn').textContent = 'انشاء حساب / تسجيل';
                document.getElementById('loginBtn').onclick = showRegister;
                localStorage.removeItem('current_user');
            }
        }

        /*******************
         * رندر المواقف
         *******************/
        function renderParkingSlots(){
            // طبق الفلاتر
            const area = document.getElementById('areaFilter').value || 'all';
            const type = document.getElementById('typeFilter').value || 'all';
            const query = document.getElementById('globalSearch').value?.trim().toLowerCase() || '';

            let filtered = parkingSlots.filter(slot => {
                if(area !== 'all' && slot.area !== area) return false;
                if(type !== 'all' && slot.type !== type) return false;
                if(query){
                    const q = query;
                    if(!(slot.number.toLowerCase().includes(q) || slot.location.toLowerCase().includes(q))) return false;
                }
                return true;
            });

            parkingGrid.innerHTML = '';
            filtered.forEach(slot => {
                const card = document.createElement('div');
                card.className = 'slot';

                let badgeClass = slot.status === 'available' ? 'available' : (slot.status === 'occupied' ? 'occupied' : 'maintenance');
                let typeBadge = slot.type === 'vip' ? 'vip' : '';

                card.innerHTML = `
                    <div class="slot-head">
                        <div>
                            <div class="slot-number">${slot.number}</div>
                            <small class="muted">${slot.location}</small>
                        </div>
                        <div style="text-align:left">
                            <div style="display:flex; gap:8px; align-items:center; justify-content:flex-end;">
                                <div class="badge ${badgeClass}">${slot.status === 'available' ? 'متاح' : slot.status === 'occupied' ? 'محجوز' : 'صيانة'}</div>
                                ${slot.type === 'vip' ? '<div class="badge vip">مميز</div>' : ''}
                            </div>
                        </div>
                    </div>

                    <div class="slot-body">
                        <div style="display:flex; justify-content:space-between; align-items:center">
                            <div class="price">${slot.price} ج.م / ساعة</div>
                            <div class="muted">نوع: ${slot.type === 'regular' ? 'عادي' : slot.type === 'disabled' ? 'ذوي احتياجات' : 'مميز'}</div>
                        </div>
                    </div>

                    <div class="slot-actions">
                        ${slot.status === 'available' ? `<button class="btn-block btn-book" onclick="openBookingModal(${slot.id})">احجز الآن</button>` : `<button class="btn-block btn-disabled" disabled>غير متاح</button>`}
                        <button class="btn-block" onclick="viewSlotDetails(${slot.id})">تفاصيل</button>
                    </div>
                `;
                parkingGrid.appendChild(card);
            });

            // إحصاءات
            statTotal.textContent = `المجموع: ${parkingSlots.length}`;
            statAvailable.textContent = `متاح: ${parkingSlots.filter(s=>s.status==='available').length}`;
            statOccupied.textContent = `محجوز: ${parkingSlots.filter(s=>s.status==='occupied').length}`;
            localStorage.setItem('parking_slots', JSON.stringify(parkingSlots));
        }

        /*******************
         * قائمة المواقع
         *******************/
        function renderLocationsList(){
            const areas = [
                {key:'college', title:'كلية التعليم الصناعي', desc:'مواقف قريبة من بوابة الكلية'},
                {key:'uni', title:'الجامعة الأهلية', desc:'بوابة الجامعة و المواقف الداخلية'},
                {key:'dispacito', title:'كافيه ديسباسيتو', desc:'شارع المقاهي والمطاعم'},
                {key:'oasis', title:'كافيه واحة البكري', desc:'مواقف مخصصة للكافيه'},
                {key:'central', title:'المنطقة المركزية', desc:'مركز الخدمات و المكاتب'}
            ];

            locationsList.innerHTML = '';
            areas.forEach(a=>{
                const el = document.createElement('div');
                el.className = 'loc-item';
                el.innerHTML = `<div>
                                    <div style="font-weight:800">${a.title}</div>
                                    <small class="muted">${a.desc}</small>
                                </div>
                                <div style="display:flex; gap:8px; align-items:center">
                                    <button class="btn ghost" onclick="filterByArea('${a.key}')">عرض</button>
                                    <div class="muted">${parkingSlots.filter(s=>s.area===a.key).length} موقف</div>
                                </div>`;
                locationsList.appendChild(el);
            });
        }

        function filterByArea(areaKey){
            document.getElementById('areaFilter').value = areaKey;
            applyFilters();
        }

        function applyFilters(){
            renderParkingSlots();
        }

        /*******************
         * البحث
         *******************/
        function applySearchListener(){
            document.getElementById('globalSearch').addEventListener('input', function(){
                renderParkingSlots();
            });
        }

        /*******************
         * حجز الموقف
         *******************/
        function openBookingModal(slotId){
            // إذا لم يتم تسجيل الدخول — نطلب التسجيل أولاً
            if(!currentUser){
                showRegister();
                alert('يرجى إنشاء حساب أو تسجيل الدخول قبل الحجز.');
                return;
            }

            selectedSlot = parkingSlots.find(s => s.id === slotId);
            selectedDuration = 1;
            selectedPayment = 'wallet';

            modalContent.innerHTML = `
                <div style="display:flex; flex-direction:column; gap:8px">
                    <div><strong>الموقف:</strong> ${selectedSlot.number} — <span class="muted">${selectedSlot.location}</span></div>
                    <div><strong>السعر/ساعة:</strong> ${selectedSlot.price} ج.م</div>

                    <label class="muted">مدة الحجز (ساعات)</label>
                    <select id="bookingDuration" class="form-control" onchange="onDurationChange(this.value)">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="8">8</option>
                        <option value="24">24</option>
                    </select>

                    <label class="muted">طريقة الدفع</label>
                    <select id="bookingPayment" class="form-control" onchange="onPaymentChange(this.value)">
                        <option value="wallet">المحفظة</option>
                        <option value="card">بطاقة ائتمان</option>
                        <option value="cash">نقدي</option>
                    </select>

                    <div class="muted">المبلغ الإجمالي: <span id="bookingTotal">${selectedSlot.price} ج.م</span></div>

                    <div class="qr-box" id="qrPreview" style="display:none">
                        <div style="font-weight:800">QR Code (حجوزتك)</div>
                        <small class="muted">اعرضه عند الدخول/الخروج</small>
                        <div id="qrText" style="margin-top:8px; font-weight:700; word-break:break-all"></div>
                    </div>
                </div>
            `;

            // ربط زر التأكيد بحيث يتغير السلوك بحسب الاختيارات داخل المودال
            confirmBookingBtn.disabled = false;
            modalBackdrop.style.display = 'flex';
        }

        function onDurationChange(val){
            selectedDuration = parseInt(val);
            updateBookingTotal();
        }

        function onPaymentChange(val){
            selectedPayment = val;
            updateBookingTotal();
        }

        function updateBookingTotal(){
            if(!selectedSlot) return;
            const total = selectedSlot.price * selectedDuration;
            document.getElementById('bookingTotal').textContent = `${total} ج.م`;
        }

        function confirmBooking(){
            if(!currentUser || !selectedSlot) return;

            const totalAmount = selectedSlot.price * selectedDuration;

            if(selectedPayment === 'wallet'){
                if((currentUser.balance ?? 0) < totalAmount){
                    alert('رصيد المحفظة غير كافٍ. يمكنك شحن المحفظة أو اختيار طريقة دفع أخرى.');
                    return;
                }
                // خصم
                currentUser.balance = (currentUser.balance ?? 0) - totalAmount;
                // تحديث المستخدم في الذاكرة
                const idx = users.findIndex(u=>u.id === currentUser.id);
                if(idx !== -1) users[idx].balance = currentUser.balance;
                localStorage.setItem('parking_users', JSON.stringify(users));
                localStorage.setItem('current_user', JSON.stringify(currentUser));
            }

            // إنشاء كائن الحجز
            const bookingCode = `EGP-${Date.now()}-${Math.floor(Math.random()*9000+1000)}`;
            const newBooking = {
                id: Date.now(),
                userId: currentUser.id,
                slotId: selectedSlot.id,
                slotNumber: selectedSlot.number,
                duration: selectedDuration,
                totalAmount: totalAmount,
                paymentMethod: selectedPayment,
                status: 'active',
                createdAt: new Date().toISOString(),
                qrCode: bookingCode
            };
            bookings.push(newBooking);
            localStorage.setItem('parking_bookings', JSON.stringify(bookings));

            // تحديث حالة الموقف
            const si = parkingSlots.findIndex(s=>s.id===selectedSlot.id);
            if(si !== -1) parkingSlots[si].status = 'occupied';
            localStorage.setItem('parking_slots', JSON.stringify(parkingSlots));

            // تحديث الواجهة
            renderParkingSlots();
            renderBookings();
            updateAuthUI();

            // عرض QR داخل المودال
            const qrBox = document.getElementById('qrPreview');
            const qrText = document.getElementById('qrText');
            qrBox.style.display = 'block';
            qrText.textContent = newBooking.qrCode;

            confirmBookingBtn.disabled = true;
            confirmBookingBtn.textContent = 'تم الحجز';
            setTimeout(()=>{ closeModal(); confirmBookingBtn.textContent = 'تأكيد الحجز'; confirmBookingBtn.disabled = false }, 1200);
            alert(`تم الحجز بنجاح — المبلغ: ${totalAmount} ج.م\nرمز الحجز: ${newBooking.qrCode}`);
        }

        function closeModal(){
            modalBackdrop.style.display = 'none';
            selectedSlot = null;
        }

        function viewSlotDetails(slotId){
            const slot = parkingSlots.find(s=>s.id===slotId);
            if(!slot) return;
            alert(`تفاصيل الموقف:\n\nالرقم: ${slot.number}\nالموقع: ${slot.location}\nالنوع: ${slot.type}\nالسعر: ${slot.price} ج.م / ساعة\nالحالة: ${slot.status}`);
        }

        /*******************
         * الحجوزات و العرض
         *******************/
        function renderBookings(){
            bookingsList.innerHTML = '';
            const recent = bookings.slice().reverse().slice(0,6);
            if(recent.length === 0){
                bookingsList.innerHTML = `<div class="muted">لا توجد حجوزات حتى الآن</div>`;
            }else{
                recent.forEach(b=>{
                    const item = document.createElement('div');
                    item.className = 'booking-item';
                    const slot = parkingSlots.find(s=>s.id===b.slotId) || {number:b.slotNumber};
                    item.innerHTML = `<div style="display:flex; flex-direction:column">
                                            <div style="font-weight:800">${slot.number}</div>
                                            <small class="muted">${new Date(b.createdAt).toLocaleString()}</small>
                                        </div>
                                        <div style="text-align:left">
                                            <div style="font-weight:800">${b.totalAmount} ج.م</div>
                                            <small class="muted">${b.status} — ${b.paymentMethod}</small>
                                            <div style="margin-top:6px; display:flex; gap:6px; justify-content:flex-end">
                                                <button class="btn ghost" onclick="showBookingQR('${b.qrCode}')">عرض QR</button>
                                                <button class="btn" onclick="cancelBooking(${b.id})">إلغاء</button>
                                            </div>
                                        </div>`;
                    bookingsList.appendChild(item);
                });
            }
        }

        function viewMyBookings(){
            // فتح قائمة الحجوزات (نفس القائمة المعروضة)
            alert('تفاصيل الحجوزات ظاهرة أسفل المواقف (آخر الحجوزات).');
        }

        function showBookingQR(code){
            alert(`رمز الحجز:\n\n${code}\n\nاعرض هذا الرمز عند البوابة`);
        }

        function cancelBooking(bookingId){
            const i = bookings.findIndex(b=>b.id===bookingId && b.status==='active');
            if(i === -1){
                alert('لا يوجد حجز نشط بهذا الرقم');
                return;
            }
            // إلغاء واسترجاع المبلغ إن كان من المحفظة
            const b = bookings[i];
            b.status = 'cancelled';
            bookings[i] = b;
            // تحرير الموقف
            const si = parkingSlots.findIndex(s=>s.id===b.slotId);
            if(si !== -1) parkingSlots[si].status = 'available';

            // استرداد المبلغ للمحفظة إن كان الدفع بالمحفظة
            if(b.paymentMethod === 'wallet'){
                const uidx = users.findIndex(u=>u.id === b.userId);
                if(uidx !== -1){
                    users[uidx].balance = (users[uidx].balance ?? 0) + b.totalAmount;
                    if(currentUser && currentUser.id === users[uidx].id){
                        currentUser.balance = users[uidx].balance;
                        localStorage.setItem('current_user', JSON.stringify(currentUser));
                    }
                }
            }

            localStorage.setItem('parking_bookings', JSON.stringify(bookings));
            localStorage.setItem('parking_slots', JSON.stringify(parkingSlots));
            localStorage.setItem('parking_users', JSON.stringify(users));

            renderParkingSlots();
            renderBookings();
            updateAuthUI();
            alert('تم إلغاء الحجز واسترجاع المبلغ (إن وُجد من المحفظة).');
        }

        /*******************
         * تسجيل / شحن محفظة
         *******************/
        function showRegister(){
            registerBackdrop.style.display = 'flex';
        }

        function closeRegister(){
            registerBackdrop.style.display = 'none';
        }

        function submitRegister(){
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const plate = document.getElementById('regPlate').value.trim();
            const pwd = document.getElementById('regPassword').value.trim();
            if(!name || !email || !pwd){
                alert('يرجى ملء الحقول الأساسية (الاسم، البريد، كلمة المرور).');
                return;
            }
            if(users.find(u=>u.email === email)){
                alert('هذا البريد مُسجل بالفعل، حاول تسجيل الدخول.');
                return;
            }
            const newUser = {
                id: Date.now(),
                name, email, password: pwd, carPlate: plate, balance: 200 // رصيد ابتدائي تشجيعي
            };
            users.push(newUser);
            localStorage.setItem('parking_users', JSON.stringify(users));
            currentUser = newUser;
            localStorage.setItem('current_user', JSON.stringify(currentUser));
            updateAuthUI();
            closeRegister();
            alert('تم إنشاء الحساب بنجاح! تم إضافة 200 ج.م رصيد ابتدائي.');
            renderBookings();
        }

        function logout(){
            if(confirm('هل ترغب بتسجيل الخروج؟')){
                currentUser = null;
                updateAuthUI();
            }
        }

        function showTopUp(){
            if(!currentUser){ showRegister(); alert('يرجى تسجيل / إنشاء حساب أولاً'); return; }
            topupBackdrop.style.display = 'flex';
        }

        function closeTopUp(){ topupBackdrop.style.display = 'none'; }

        function submitTopUp(){
            const amount = parseFloat(document.getElementById('topupAmount').value);
            if(isNaN(amount) || amount <= 0){ alert('أدخل مبلغًا صحيحًا للشحن'); return; }
            const idx = users.findIndex(u=>u.id===currentUser.id);
            if(idx !== -1){
                users[idx].balance = (users[idx].balance ?? 0) + amount;
                currentUser.balance = users[idx].balance;
                localStorage.setItem('parking_users', JSON.stringify(users));
                localStorage.setItem('current_user', JSON.stringify(currentUser));
                updateAuthUI();
                closeTopUp();
                alert(`تم شحن المحفظة بمقدار ${amount} ج.م`);
            } else alert('حدث خطأ: المستخدم غير موجود');
        }

        /*******************
         * عناصر مساعدة
         *******************/
        function toggleFilterPanel(){
            const left = document.getElementById('leftPanel');
            left.style.display = left.style.display === 'none' ? 'block' : 'none';
        }

        function showBookingQR(code){
            alert('رمز الحجز:\n\n' + code);
        }

        // تهيئة وتحديث الواجهة عند التحميل
        window.addEventListener('DOMContentLoaded', initApp);

        // استمع إلى تغيّر خيارات الفلتر العام و تحديث
        document.getElementById('areaFilter').addEventListener('change', renderParkingSlots);
        document.getElementById('typeFilter').addEventListener('change', renderParkingSlots);

        // إعداد المستخدم الإفتراضي (إن لم يوجد)
        if(!currentUser && users.length > 0){
            // لا تفعل شيئًا - المستخدم يبقى زائر حتى يُسجل الدخول
        }

        /*******************
         * ملاحظات خفيفة:
         * - جميع الأسعار بالجنيه المصري (ج.م).
         * - تم إضافة شحن محفظة، إدارة حجوزات (إلغاء، عرض QR)، وفلاتر للمواقع.
         * - يمكن تعديل البيانات الأولية stored في localStorage تحت مفاتيح:
         *     parking_slots, parking_users, parking_bookings, current_user
         *******************/
    </script>
</body>
</html>

